---
title: python开发公众号
categories: WeiXin
---

# 原文参考
[从零开始 Python 微信公众号开发](http://www.tuicool.com/articles/36nyU3b)
[使用python一步一步搭建微信公众平台](https://my.oschina.net/yangyanxing/blog/159215)
[添加用户关注后的欢迎信息与听音乐功能](https://my.oschina.net/yangyanxing/blog/196956?p=2&temp=1486389579131#blog-comments-list)
[Python快速搭建自动回复微信公众号](http://python.jobbole.com/84904/)
[未认证订阅号自定义菜单与开发者兼得](http://jingyan.baidu.com/article/1e5468f97c3472484961b7dd.html?qq-pf-to=pcqq.c2c)
# 所遇问题
##  `git push sae master:1`时候报如下错误:
``` shell
G:\Web_python\xyPyTest>git push sae master:1
fatal: Authentication failed for 'https://git.sinacloud.com/super3h/'
```
> `解决方案:`用户名密码就是你的github账户邮箱和密码，输入密码不是没反应，是你输入了但是不会显示，你输入完直接enter就ok了，sshkey是另外一种提交方式罢了！

## `lxml`安装问题
``` bash
E:\>easy_install lxml
Searching for lxml
Reading https://pypi.python.org/simple/lxml/
Best match: lxml 3.7.2
Downloading https://pypi.python.org/packages/66/45/f11fc376f784c6f2e77ffc7a9d02374ff3ceb07ede8c56f918939409577c/lxml-3.7.2.tar.gz#md5=8dcf8d6c692b7aed9370f7462ff09935
error: ('The read operation timed out',)
```
> `解决方案:`
> 从官方网站下载与系统，Python版本匹配的lxml文件：[lxml 2.3](http://pypi.python.org/pypi/lxml/2.3/)
> 执行 `easy_install lxml-2.3-py2.7-win-amd64.egg`即可
> 详细解决方案请参考[Python lxml模块安装教程](http://www.jb51.net/article/67125.htm)

## ‘not found’页面
![](WeiXin-Python/1.png)
> 这个属于正常页面，因为index.wsgi只会接受`http://6.super3h.applinzi.com/weixin`的入口才会响应，对应微信配置如下：

![](WeiXin-Python/2.png)
> 具体详情请参考[新浪云SAE搭建python环境](http://www.cnblogs.com/yym2013/p/5962208.html)和[SAE部署Python-让云端自动运行Python代码](http://blog.csdn.net/u011659379/article/details/48314317)

## 自动回复无反应问题
> 原文参考代码有错`index.wsgi`中将`import lxml`改为`import lxml.etree as etree`，可进入sae日志中心查看代码错误原因，具体过程如下:

![](WeiXin-Python/3.png)

## 添加第三方依赖包
除了使用新浪云上已经预装的模块之外，您还可以通过以下方式给自己的应用添加第三方依赖包。

首先，在应用的根目录下创建一个第三方依赖包目录 `vendor` 。
调用` pip `命令安装依赖包，使用其` -t `选项指定第三方包的安装目录。3
``` shell
$ pip install -t vendor PACKAGE ...
```
将 `vendor` 目录和应用的代码一起提交，即可在应用代码里使用安装的第三方依赖包了。

如果依赖包安装的目录名不为 `vendor` ，你需要在 `index.wsgi` 文件的最开始，添加以下代码，将目录加入到 `sys.path` 中。
``` python
import sae
sae.add_vendor_dir('路径')
# 注意：以上代码得放在 index.wsgi 的最前面，所有其它代码之前。
```

`详情参考:`[添加第三方依赖包](https://www.sinacloud.com/doc/sae/python/tools.html#tian-jia-di-san-fang-yi-lai-bao)

## 编码问题
``` bash
(unicode error) 'utf8' codec can't decode byte 0xd6 in position 2: invalid continuation byte  yq26 
```
> `具体原因：`编码不一致，微信为gbk编码，本地为utf-8编码二导致编码不一致
> `解决方案：`将本地用gbk解码，具体操作如下：
``` python
return self.render.reply_text(fromUser, toUser, int(time.time()), ('图中人物性别为:'+datas[0]+'\n'+'年龄为:'+datas[1]).decode('gbk'))
```

## 输入<>会被转义问题
> 由于`![CDATA[$content]]`而发生转义问题，改成如下模式即可:
``` xml
$def with (toUser,fromUser,createTime,content)
<xml>
    <ToUserName><![CDATA[$toUser]]></ToUserName>
    <FromUserName><![CDATA[$fromUser]]></FromUserName>
    <CreateTime>$createTime</CreateTime>
    <MsgType><![CDATA[text]]></MsgType>
    <Content>$content</Content>
</xml>
```
## 音乐问题
> 由于百度云存储要钱的缘故。。。所以我选择了新浪云。
> `问题：`苹果手机中不能听
> `解决方案：`还没解决。。能力有限

# 新闻列表
`templates\reply_url.xml`
``` xml
$def with (toUser,fromUser,createTime,content,title,description,picUrl,url)
<xml>
    <ToUserName><![CDATA[$toUser]]></ToUserName>
    <FromUserName><![CDATA[$fromUser]]></FromUserName>
    <CreateTime>$createTime</CreateTime>
    <MsgType><![CDATA[news]]></MsgType>
    <Content><![CDATA[$content]]></Content>
    <ArticleCount>1</ArticleCount>
    <Articles>
        <item>
            <Title><![CDATA[$title]]></Title>
            <Description><![CDATA[$description]]>
    </Description>
            <PicUrl><![CDATA[$picUrl]]></PicUrl>
            <Url><![CDATA[$url]]></Url>
        </item>
    </Articles>
    <FuncFlag>0</FuncFlag>
</xml>
```
`weixinInterface.py添加这一句:`
``` python
def POST(self): 
		if msgType == 'text':
			content = xml.find("Content").text
			if content.lower().strip() == 'help':
				replayText = '1.输入 天气+城市 返回当天的该城市的天气\n2.输入m随机来首音乐听，！！！点击中间暂停键即可收听！！！建议在wifi下听(苹果手机不提供改功能)\n3.发送图片 可以进行人脸识别\n4.输入时间+城市+城市+工具 例如明天武汉到黄石的火车 发送给您购票链接\n5.输入图片信息  发送给您的图片链接\n6.输入新闻，发送今天相关的新闻\n7.输入博客，可以访问我的个人博客'.decode('gbk')
				return self.render.reply_text(fromUser,toUser,int(time.time()),replayText)
			if content.lower().strip() == 'm':
				musicList = [
					[r'http://cdn.sinacloud.net/super3h/%E8%B5%B5%E9%9B%B7-%E6%88%90%E9%83%BD.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=Amv0p6bpTP','成都'.decode('gbk'),'一首关于成都的民谣'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E5%A5%87%E5%A6%99%E8%83%BD%E5%8A%9B%E6%AD%8C%20%E9%99%88%E7%B2%92.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=naNA%2BnoLeX','奇妙能力歌'.decode('gbk'),'我有那么多奇妙的能力，却留不住你'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E4%B8%83%E6%9C%88%E4%B8%8A.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=10lmgvWDSk','七月上'.decode('gbk'),'我欲乘风破浪，相敬流年，不负相识一场'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E5%88%B0%E4%B8%8D%E4%BA%86.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=q5Uvmym2dp','到不了'.decode('gbk'),'心这个东西.如果先伤了别人的 总有一天会加倍伤回来的..放心 谁也跑不了'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E5%8D%97%E4%B8%8B.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=paaVSCLmSP','南下'.decode('gbk'),'生来北方人，不知江南心'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E5%8E%9F%E8%B0%85.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=JW7EyeexGp','房间'.decode('gbk'),'在这温暖的房间 我们都笑得很甜 一切停格在一瞬'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E5%91%8A%E7%99%BD%E6%B0%94%E7%90%83.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=HfJSFIkSy5','告白气球'.decode('gbk'),'想喜欢的Ta告白吧'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E6%88%91%E8%A6%81%E4%BD%A0.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=Jlr9j%2FzEX1','我要你'.decode('gbk'),'我想要更好更圆的月亮， 想要未知的疯狂， 想要声色的张扬， 我想要你。'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E6%98%A5%E5%A4%8F%E7%A7%8B%E5%86%AC%E7%9A%84%E4%BD%A0.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=wgqRrlxCdY','春夏秋冬的你'.decode('gbk'),'我喜欢 春天的花 夏天的树 秋天的黄昏 冬天的阳光 和 每天的你'.decode('gbk')],
					[r'http://cdn.sinacloud.net/super3h/%E7%88%B1%E6%83%85.mp3?KID=sina,2h52m0fNhoTzn5PApHvr&Expires=1486396834&ssig=%2B%2FTnudrYIP','爱情'.decode('gbk'),'爱是折磨人的东西,却又舍不得这样放弃'.decode('gbk')]
				
				]
				music = random.choice(musicList)
				musicurl = music[0]
				musictitle = music[1]
				musicdes = music[2]
				return self.render.reply_music(fromUser,toUser,int(time.time()),musictitle,musicdes,musicurl)
			if content == '博客'.decode('gbk'):
				return self.render.reply_url(fromUser,toUser,int(time.time()),content,'个人博客'.decode('gbk'),'HHH的个人博客'.decode('gbk'),r'https://mmbiz.qlogo.cn/mmbiz_jpg/z67Nqg3yAzRNVazozLUD7icuibRJdnCDaJd1dTfQ9673IDS6ttA5cFQwQCic7IrjPhbTcX1ycQDGibJhlGaFbwzyyg/0?wx_fmt=jpeg',r'http://super3h.github.io')
			tuling = TulingAutoReply('b2091cea56054fc88d857baf3f926fbd',r'http://www.tuling123.com/openapi/api')
			replayText = tuling.reply(content)
			if isinstance(replayText,list):
				articleList = [article['article']+'\n详情'.decode('gbk')+article['detailurl'] for article in replayText]
				reply = random.choice(articleList)
				return self.render.reply_text(fromUser,toUser,int(time.time()),reply)
			if replayText is None :
				replayText = '就不能说点能听懂的话么？？'.decode('gbk')
			return self.render.reply_text(fromUser,toUser,int(time.time()),replayText)
		elif msgType == 'image':
			try:
				#拿到系统生成的图片链接
				picurl = xml.find('PicUrl').text
				datas = imgtest(picurl)
				return self.render.reply_text(fromUser, toUser, int(time.time()), ('图中人物性别为:'+datas[0]+'\n'+'年龄为:'+datas[1]).decode('gbk'))
			except:
				return self.render.reply_text(fromUser, toUser, int(time.time()), ('我只能识别人类，不是人的照片就别拿过来了').decode('gbk'))
		else:
			return self.render.reply_text(fromUser, toUser, int(time.time()), ('功能只有这么多，能力有限，不好意思').decode('gbk'))
```
> 博主本来准备做新闻列表和语音识别，结果新浪云莫名报错，花了我一下午还没解决，这里把原文贴出来，供大家参考[听得懂语音消息的聊天机器人](https://zhuanlan.zhihu.com/p/21390250)
# 源码链接
欢迎订阅 [ProgrammerBy3H](https://github.com/super3H/sae/tree/master) `求star star star！！`