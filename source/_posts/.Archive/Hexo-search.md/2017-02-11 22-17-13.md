---
title: Hexo-本地搜索
categories: Hexo
---

# 安装和配置插件
` 1、` `cd`到根目录下
``` shell
$ npm install --save hexo-generator-search
```
` 2、` 在`__config.yml`最后添加一下设置项(`注意:`缩进问题，建议直接`copy`)
``` yml
search:
  path: search.xml
  field: all
```
说明:
- `path:`指定生成的索引数据的文件名。默认为 `search.xml` 。
- `field` 指定索引数据的生成范围。可选值包括：
    - `post` - 只生成博客文章（post）的索引（默认）；
    - `page:`只生成其他页面（page）的索引；
    - `all:`生成所有文章和页面的索引。
# 搜索函数的创建
新建search.js在`themes\jacman\source\js`目录中，部署后将位于`public\js`
此函数参考于[实现本地搜索函数](http://hahack.com/codes/local-search-engine-for-hexo/#实现本地搜索函数)
``` js
var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 100;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                });
                str += "</ul>";
                $resultContent.innerHTML = str;
            });
        }
    });
}
```
- `searchFunc(path, search_id, content_id) `包含三个参数：

- `path:`用 hexo-generator-search 生成的搜索索引文件的路径。注意这个 path 和前面 hexo-generator-search 的 path 选项有所不同。这里的 path 才是指这个文件的路径，而前面的 path 指的是生成的文件名
- `search_id:`搜索框的 id 。对于我们的例子，就是 local-search-input;
- `content_id:` 结果框的 id 。对于我们的例子，就是 local-search-result

# 搜索函数文件的引入
既然搜索函数已创建，接下来就是调用了。
> 调用之前有必要明白`themes\jacman\layout\_partial\header.ejs`中最后一个`form`表单即为页面中的`search`框
![](Hexo-search/1.png)
> 对应代码如下:
``` html
<form class="search">
						<label>Search</label>
						<input type="text" id="search" class="search form-control" autocomplete="off" maxlength="20" placeholder="<%= __('search') %>" autocorrect="off"/>
					</form>
```
在目录`themes\jacman\layout\_partial\after_footer.ejs`中，添加一下内容:
``` js
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script src="<%- config.root %>js/jquery-2.0.3.min.js"></script>
<script src="<%- config.root %>js/jquery.imagesloaded.min.js"></script>
<script src="<%- config.root %>js/gallery.js"></script>
<script src="<%- config.root %>js/jquery.qrcode-0.12.0.min.js"></script>
//以下是引入我们创建的js文件
<script src="<%- config.root %>js/search.js"></script>
```
> `after_footer.ejs`专门存放各种`js`文件，从此处引入我们创建的`search.js`文件

# 输入框的整改
> `思考:`由于主题原因，我们有两条路走：
> 1.写一个html页面用于显示搜索后的结果
> 2.用div叠加在原页面上，在进行搜索和结果展示
> 博主走的第二条路，样式如下:
![](Hexo-search/2.PNG)
> 由于博主前台很渣，能做成这样就不错了。虽然后台也好不到哪去，哈哈
> 要添加此样式就得找到添加的位置，`themes\jacman\layout\layout.ejs`，此文件用于页面的排布,分别对应了文章，分类，归档等的排布，我们分别在每个`<header>`后加入以下代码
``` html
<header>
      <%- partial('_partial/header') %>
</header>
<!--添加以下代码-->
	<div id="ly" style="width:100%;height:100%;position: fixed; top: 0px; opacity:0.5; background-color: #6F6F6F;
         z-index: 2; left: 0px; display: none;" onclick="Lock_CheckForm()">
		</div>
		<!--浮层框架开始-->
		<div id="Layer2" align="center" style="width: 950px; position: absolute;left: 200px ;top:10%;z-index: 3;background-color: #fff; display: none;border-radius: 10px;">
			<div style="background-color: #F8F8F8;border-radius: 10px;">
				<input type="text" value="" id="local-search-input" placeholder="search this website" autocomplete="off" autocorrect="off" autocapitalize="off" style="outline: none;">
				<span class="local-search-close" onclick="Lock_Reset()"></span>
				<!-- 清空/重置搜索框 -->
				<br><br>
			</div>
			<div id="local-search-result"></div> <!-- 搜索结果区 -->
		</div>
		<!--  浮层框架结束-->
```
> 说明:
> `#ly`:用于暗色背景
> `#Layer2`:用于搜索和结果展示
> `div #local-search-input`:搜索框
> `div #local-search-close`:用于清空搜索框内容
> `div #local-search-result`:用于结果展示

# 浮层样式的添加
> `html`写完后,改写css了，博主把所有的样式写在一个文件中了，以免乱套
> 在`themes\jacman\source\css`新建`search.styl`，此文件夹用于页面所有样式的展示，对应的代码如下:
``` css
ul.search-result-list {
  padding-left: 10px;
}
a.search-result-title {
  font-weight: bold;
}
p.search-result {
  color=#555;
}
em.search-keyword {
  border-bottom: 1px dashed #4088b8;
  font-weight: bold;
}
/*搜索框样式*/
#local-search-input {
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
#local-search-input {
	font-size: 13px;
	min-height: 32px;
	margin: 0;
	padding: 7px 8px;
	outline: none;
	color: #333;
	background-color: #fff;
	background-repeat: no-repeat;
	background-position: right center;
	border: 1px solid #ccc;
	border-radius: 3px;
	box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.075);
	-moz-box-sizing: border-box;
	box-sizing: border-box;
	transition: all 0.15s ease-in;
	-webkit-transition: all 0.15s ease-in 0;
	vertical-align: middle;
}

#local-search-input:focus {
	outline: none;
	border-color: #51a7e8;
	box-shadow: inset 0 1px 2px rgba(0, 0, 0, .075), 0 0 5px rgba(81, 167, 232, .5);
}

#local-search-input {
	margin-top: 20px;
	margin-left: -46px;
	font-size: 18px;
	width: 850px;
	height: 30px;
}
/*搜索重置按钮*/
.local-search-close:hover {
	zoom: 1.0;
	padding: 1px 0.6em;
	border: 1px solid #d3d3d3;
	box-shadow: 0 0 6px rgba(0, 0, 0, 0.25);
	background: #FAF7F4;
}
.local-search-close:active {
	background: #d3d3d3;
}
.local-search-close {
	padding: 1px 0.7em;
	box-shadow: 0 0 3px rgba(0, 0, 0, 0.15);
	cursor: pointer;
	color: #808080;
}
.local-search-close::before {
	content: "\2716";
}
/* place the button on top-right */
.local-search-close {
	top: 22px;
	right: 28px;
	position: absolute;
}
/*搜索结果区*/
#local-search-result {
  font-size: 0.9em;
  text-align: left;
  word-break: break-all;
}

#local-search-result ul.search-result-list li:hover {
  font-weight: normal;
}

/*搜索预览段落*/
#local-search-result p.search-result {
  margin: 0.4em auto;
  max-height: 3.6em;
  overflow: hidden;
  font-size: 0.8em;
  text-align: justify;
  color: #808080;
}

/*匹配的关键词*/
#local-search-result em.search-keyword {
  color: #f58e90;
  border-bottom: 1px dashed #f58e90;
  font-weight: bold;
  font-size: 0.85em;
}
```
> 之后就要添加样式文件了，我们到`themes\jacman\layout\_partial\head.ejs`文件中的最后几行中添加以下代码:
``` css
<%- css('css/style') %>
/*以下为添加的内容*/
<%- css('css/search') %>
```

# 函数调用和事件添加
> 样式也添加完了，接下来就是函数调用和事件添加，到`themes\jacman\layout\_partial\after_footer.ejs`目录下，在刚才引入search.js的下面添加以下代码:
``` js
<script src="<%- config.root %>js/search.js"></script>
<script type="text/javascript">
//div层的显示
function locking() {
	document.all.ly.style.display = "block";
	document.all.Layer2.style.display = 'block';
}
//div层的隐藏
function Lock_CheckForm() {
	document.all.ly.style.display = 'none';
	document.all.Layer2.style.display = 'none';
	return false;
}
//重置搜索框
function Lock_Reset() {
	$("#local-search-input").val('');
} 
//拿到文件路径
var search_path = "<%= config.search.path %>";
if (search_path.length == 0) {
		search_path = "search.xml";
	}
var path = "<%= config.root %>" + search_path;
//拿到页面自带的搜索框元素
var inputArea = document.querySelector("#search");
//禁止回车的输入
inputArea.onkeydown = function(){ if(event.keyCode==13) return false}
var getSearchFile = function(){
    //调用搜索函数
    searchFunc(path, 'local-search-input', 'local-search-result');
}
//给页面自带的搜索框元素添加聚焦时间
inputArea.onfocus = function(){ 
	locking();
	getSearchFile();
}
getSearchFile();
</script>
```
> 到此也就结束了，大家可以按照自己的样式修改，最后贴出我的成果
![](Hexo-search/3.png)

# 参考链接
在此谢谢这两位博主的参考