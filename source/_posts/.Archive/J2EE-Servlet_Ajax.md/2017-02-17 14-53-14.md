---
title: Servlet与ajax结合
---
# 项目想法
> 由于老是逛微博，发现每到滑轮到底时就会刷新数据，今天刚好有时间，就自己尝试了一下，由于三大框架还不太熟，所以用的是servlet。后期改成ssh。

# 项目过程
> 由于这是一个小项目，就讲下自己所遇到的问题吧。
## 滑轮触发事件
> `首先:`从前台开始分析，滑轮滚到底会触发一个事件，代码如下:
``` js
$().ready(function(){
	$(window).bind("scroll",function(){
	var $height = $(this).height();//可见高度
	var $contentH = $(document).height();//内容高度
	var $scrollTop = $(this).scrollTop();//滚动的高度
	if(($scrollTop+$height)==$contentH){
		  //加载数据
		}
	})
})
```
> `滚动高度+可见的高度=内容的高度`；本代码是滚轮划到底部时才触发的事件，也可以设置一个范围，将`if`里的内容改成如下代码：`$scrollTop/($contentH-$height)>0.95`

## Ajax加载数据
> 由于本项目比较简单，就采用了`$.post`就行了，这里简单介绍一下`$.post`和`$.ajax`的区别
> `$.post(url, [data], [callback], [type]):`这是一个简单的 POST 请求功能以取代复杂 `$.ajax` 。请求成功时可调用回调函数。如果需要在出错时执行函数，请使用 `$.ajax`。
    - `url:`发送请求地址
    - `data:`待发送 Key/value 参数
    - `callback:`发送成功时回调函数
    - `type:`返回内容格式，xml, html, script, json, text, _default.
> `$.aajax([options]):`jQuery 底层 AJAX 实现。简单易用的高层实现见 $.get, $.post 等。$.ajax() 返回其创建的 `XMLHttpRequest` 对象。大多数情况下你无需直接操作该函数，除非你需要操作不常用的选项，以获得更多的灵活性。 具体请自行百度。

## 具体代码
> 以下ajax代码添加在滑轮触发事件的if内部;
``` js
$.post("${pageContext.request.contextPath}/clientServlet",{
				//待发送的参数
			},function(data){
				    //成功后执行的代码
				})
			})
```
> 本例中时候向`clientServlet`发送数据
> 接下来是`servlet`内的代码
``` java
resp.setContentType("text/html;charset=utf-8");
		PrintWriter out = resp.getWriter();
		String way = req.getParameter("way");
		int page;
		if(req.getParameter("page")==null||"".equals(req.getParameter("page")))
			page = 1;
		else page = Integer.parseInt(req.getParameter("page"));
		//准备要显示的数据
		Page p = service.listAirticle(page);
		if("post".equals(way)){
			List<Weibo> weibos = p.getRecords();
			//TODO:weibos为null？？
			out.println("{weibos:"+JsonParse.parse(weibos)+"}");
			out.close();
		}else {
			req.setAttribute("page", p);
			req.getRequestDispatcher("/WEB-INF/jsp/list.jsp").forward(req, resp);
		}
```
> 本来以为这样就可以不用分页了，天真的我发现不用分页不行呐。。这里解释一下思路:每到滑轮滚到底部时，触发ajax事件，同时把当前页加1，此时servlet负责查询下一页数据，并`out.println`，也就是写给`ajax`里的data,注意:**写过去的时候为json格式，但data里的为字符串**，需要将字符串转换成`json`格式，下面会讲

# 项目所遇问题
- 图片显示:[浏览器中显示图片](https://super3h.me/2017/02/15/J2EE-%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA/)
- json转为字符串:
1、eval方式解析
``` js
function strToJson(str){
    var json = eval('(' + str + ')');
    return json;
} 
```
2、new Function形式，比较怪异哦
``` js
function strToJson(str){
    var json = (new Function("return " + str))();
    return json;
} 
```
3、使用全局的JSON对象
``` js
var str = '{"name":"jack"}';
var obj = JSON.parse(str); 
```
注意:**这里必须采用严格的json格式，name一定要用引号引起来，否则解析失败**
详细可参考[js中将字符串转换成json的三种方式](http://www.jb51.net/article/25987.htm)
- foreach的运用方法:[JS中的forEach、$.each、map方法推荐](http://www.jb51.net/article/81955.htm)
- Jquery中添加元素方法中:append()和after(),prepend()和before()的区别:
    - `append`和`prepend`是指在元素内部添加而`after`和`before`是指在元素外添加，代码解释如下:
``` html
<!-- 此为在元素内部 -->
<p>This is a paragraph. <b>Appended text</b>.</p>
<!-- 此为在元素外部 -->
<p>This is a paragraph.</p> <b>Appended text</b>
```

# 源码如下
- js完整代码如下:
``` js
$().ready(function(){
	var x = 0;
	var page = ${page.page};
	$(window).bind("scroll",function(){
	var $height = $(this).height();//可见高度
	var $contentH = $(document).height();//内容高度
	var $scrollTop = $(this).scrollTop();//滚动的高度
	if(($scrollTop+$height)==$contentH){
		x += 1;
		$.post("${pageContext.request.contextPath}/clientServlet",{
				operation:"listAirticle",
				way:"post",
				//每次滑轮拖到底部，当前页面就加1，直到无内容显示
				page:page+x
			},function(data){
				var dataJson = eval("("+data+")");
				dataJson.weibos.forEach(function(value){
					var $p = "<p>"+value.airticle+"</p>";
					var $img = "<img width='200px' height='100px' src='http://localhost:8080${pageContext.request.contextPath}/clientServlet?showImg="+value.filename+"&operation=showImg&id="+value.id+"' />";
					$("body").append($p);
					$("body").append($img);
				})
			})
		}
	})
})
```
更详细内容，请参考[AjaxTest](https://github.com/super3H/AjaxTest/tree/master/AjaxTest)